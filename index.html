<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kasse Sommerfest - Touch-Optimiert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }
        
        /* Neues Numpad-Design orientiert am Bild */
        .numpad-dark-btn {
            @apply bg-[#2c2c2e] hover:bg-[#3c3c3e] active:bg-blue-600 text-white text-5xl font-black py-8 rounded-[2rem] transition-all shadow-lg flex items-center justify-center select-none;
        }
        
        .action-btn {
            @apply py-10 rounded-[2.5rem] font-black text-white transition-all active:scale-95 shadow-xl text-xl uppercase tracking-widest select-none;
        }
        .quantity-btn {
            @apply w-24 h-24 rounded-[2rem] flex items-center justify-center text-4xl font-black transition-all active:scale-90 select-none;
        }
        .no-select {
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-10 no-select">

    <div id="app" class="max-w-6xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-4 rounded-3xl shadow-blue-200 shadow-lg">
                    <span class="text-2xl">‚òÄÔ∏è</span>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-slate-800 tracking-tight">Kasse</h1>
                    <div class="flex items-center gap-2">
                        <span id="syncStatus" class="w-3 h-3 rounded-full bg-yellow-500"></span>
                        <p id="statusText" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Initialisierung...</p>
                    </div>
                </div>
            </div>
            <nav class="flex gap-2 bg-slate-100 p-2 rounded-[2rem]">
                <button onclick="switchTab('sell')" id="nav-sell" class="px-8 py-3 rounded-[1.5rem] font-black transition-all bg-white text-slate-800 shadow-sm">Verkauf</button>
                <button onclick="switchTab('stats')" id="nav-stats" class="px-8 py-3 rounded-[1.5rem] font-black transition-all text-slate-400">Bilanz</button>
                <button onclick="openCustomerView()" class="p-3 text-slate-400 hover:text-blue-500 transition-colors" title="Kundenansicht √∂ffnen">üñ•Ô∏è</button>
                <button onclick="requestSettingsAccess()" class="p-3 text-slate-400 hover:text-slate-800 transition-colors">‚öôÔ∏è</button>
            </nav>
        </header>

        <!-- Verkauf View -->
        <div id="tab-sell" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Linke Seite: Menge -->
            <div class="lg:col-span-6 space-y-6">
                <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-200">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 text-center">Marken Anzahl</h2>
                    <div class="flex items-center justify-between gap-4 mb-8">
                        <button onclick="changeQuantity(-1)" class="quantity-btn bg-slate-100 text-slate-800">Ôºç</button>
                        <div class="text-center flex-1">
                            <span id="quantity" class="text-9xl font-black text-slate-800 tabular-nums">0</span>
                        </div>
                        <button onclick="changeQuantity(1)" class="quantity-btn bg-blue-100 text-blue-600">Ôºã</button>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <button onclick="setQuantity(5)" class="bg-slate-50 py-6 rounded-3xl font-black text-slate-600 border-2 border-slate-100 active:bg-slate-200">+5</button>
                        <button onclick="setQuantity(10)" class="bg-slate-50 py-6 rounded-3xl font-black text-slate-600 border-2 border-slate-100 active:bg-slate-200">+10</button>
                        <button onclick="setQuantity(20)" class="bg-slate-50 py-6 rounded-3xl font-black text-slate-600 border-2 border-slate-100 active:bg-slate-200">+20</button>
                    </div>
                </div>

                <div class="bg-slate-900 p-10 rounded-[3rem] shadow-2xl text-center">
                    <p class="text-slate-400 font-bold uppercase text-[10px] tracking-widest mb-2">Gesamtbetrag (√° <span id="valLabel">0,50</span>‚Ç¨)</p>
                    <h2 id="totalPrice" class="text-7xl font-black text-white tabular-nums">0,00 ‚Ç¨</h2>
                </div>
            </div>

            <!-- Rechte Seite: Numpad -->
            <div class="lg:col-span-6 bg-white p-8 rounded-[3rem] shadow-sm border border-slate-200 bg-slate-800">
                <div class="flex justify-between items-center mb-8 bg-slate-900 p-6 rounded-[2rem] border border-slate-700">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em]">Gegeben:</h2>
                    <div class="text-right">
                        <span id="cashInput" class="text-6xl font-black text-white tabular-nums">0,00</span>
                        <span class="text-2xl text-slate-500 font-bold">‚Ç¨</span>
                    </div>
                </div>

                <!-- Neues Numpad Layout -->
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <button onclick="addDigit('7')" class="numpad-dark-btn">7</button>
                    <button onclick="addDigit('8')" class="numpad-dark-btn">8</button>
                    <button onclick="addDigit('9')" class="numpad-dark-btn">9</button>
                    <button onclick="addDigit('4')" class="numpad-dark-btn">4</button>
                    <button onclick="addDigit('5')" class="numpad-dark-btn">5</button>
                    <button onclick="addDigit('6')" class="numpad-dark-btn">6</button>
                    <button onclick="addDigit('1')" class="numpad-dark-btn">1</button>
                    <button onclick="addDigit('2')" class="numpad-dark-btn">2</button>
                    <button onclick="addDigit('3')" class="numpad-dark-btn">3</button>
                    <button onclick="clearCash()" class="numpad-dark-btn text-red-400 text-4xl">C</button>
                    <button onclick="addDigit('0')" class="numpad-dark-btn col-span-2">0</button>
                </div>

                <div id="changeBox" class="bg-green-600 p-6 rounded-[2rem] mb-8 hidden shadow-xl shadow-green-900/50">
                    <div class="flex justify-between items-center text-white">
                        <span class="font-bold uppercase text-xs tracking-widest">Wechselgeld</span>
                        <span id="changeAmount" class="text-4xl font-black tabular-nums">0,00 ‚Ç¨</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="processTransaction('buy')" id="buyBtn" class="action-btn bg-green-500 hover:bg-green-600 disabled:opacity-30 disabled:hover:bg-green-500" disabled>KASSIEREN</button>
                    <button onclick="processTransaction('return')" id="returnBtn" class="action-btn bg-orange-500 hover:bg-orange-600 disabled:opacity-30 disabled:hover:bg-orange-500" disabled>RETOURE</button>
                </div>
            </div>
        </div>

        <!-- Bilanz View -->
        <div id="tab-stats" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2">Verkauft</p>
                    <h3 id="statMarken" class="text-5xl font-black text-slate-800">0</h3>
                </div>
                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                    <p class="text-[10px] text-orange-400 font-black uppercase tracking-widest mb-2">Retouren</p>
                    <h3 id="statReturns" class="text-5xl font-black text-orange-600">0</h3>
                </div>
                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 bg-blue-50/30">
                    <p class="text-[10px] text-blue-600 font-black uppercase tracking-widest mb-2">Kasse</p>
                    <h3 id="statTotal" class="text-5xl font-black text-blue-800">0,00 ‚Ç¨</h3>
                </div>
            </div>
            
            <div class="bg-white rounded-[3rem] shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-8 border-b flex justify-between items-center">
                    <h2 class="font-black text-slate-800 text-xl">JOURNAL</h2>
                    <button onclick="resetStats()" class="text-xs font-black text-red-500 uppercase p-2">Reset</button>
                </div>
                <div id="history" class="max-h-[60vh] overflow-y-auto divide-y divide-slate-50"></div>
            </div>
        </div>

        <!-- PIN Modal mit eigenem Numpad -->
        <div id="auth-modal" class="fixed inset-0 bg-slate-900/95 backdrop-blur-md z-[110] flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-[3rem] p-8 max-w-sm w-full shadow-2xl border border-slate-700">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-black text-white">PIN üîí</h2>
                    <button onclick="closeAuth()" class="text-slate-400 hover:text-white font-black uppercase text-xs">Abbrechen</button>
                </div>
                
                <div class="flex justify-center gap-4 mb-8">
                    <div id="pin-dot-1" class="w-6 h-6 rounded-full bg-slate-600 transition-colors"></div>
                    <div id="pin-dot-2" class="w-6 h-6 rounded-full bg-slate-600 transition-colors"></div>
                    <div id="pin-dot-3" class="w-6 h-6 rounded-full bg-slate-600 transition-colors"></div>
                    <div id="pin-dot-4" class="w-6 h-6 rounded-full bg-slate-600 transition-colors"></div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <button onclick="addPinDigit('7')" class="numpad-dark-btn !py-6 !text-4xl">7</button>
                    <button onclick="addPinDigit('8')" class="numpad-dark-btn !py-6 !text-4xl">8</button>
                    <button onclick="addPinDigit('9')" class="numpad-dark-btn !py-6 !text-4xl">9</button>
                    <button onclick="addPinDigit('4')" class="numpad-dark-btn !py-6 !text-4xl">4</button>
                    <button onclick="addPinDigit('5')" class="numpad-dark-btn !py-6 !text-4xl">5</button>
                    <button onclick="addPinDigit('6')" class="numpad-dark-btn !py-6 !text-4xl">6</button>
                    <button onclick="addPinDigit('1')" class="numpad-dark-btn !py-6 !text-4xl">1</button>
                    <button onclick="addPinDigit('2')" class="numpad-dark-btn !py-6 !text-4xl">2</button>
                    <button onclick="addPinDigit('3')" class="numpad-dark-btn !py-6 !text-4xl">3</button>
                    <button onclick="clearPin()" class="numpad-dark-btn !py-6 !text-3xl text-red-400">C</button>
                    <button onclick="addPinDigit('0')" class="numpad-dark-btn col-span-2 !py-6 !text-4xl">0</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal mit eigenem Numpad -->
        <div id="settings-modal" class="fixed inset-0 bg-slate-900/95 backdrop-blur-md z-[110] flex items-center justify-center p-4 hidden">
            <div class="bg-slate-800 rounded-[3rem] p-8 max-w-sm w-full shadow-2xl border border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-white">PREIS ‚öôÔ∏è</h2>
                    <button onclick="closeSettings()" class="text-slate-400 hover:text-white font-black uppercase text-xs">Zur√ºck</button>
                </div>
                
                <div class="text-center mb-8 bg-slate-900 p-6 rounded-3xl border border-slate-700">
                    <span id="settingsPriceDisplay" class="text-6xl font-black text-white tabular-nums">0,00</span>
                    <span class="text-2xl text-slate-500 font-bold">‚Ç¨</span>
                </div>

                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="addSettingsDigit('7')" class="numpad-dark-btn !py-6 !text-4xl">7</button>
                    <button onclick="addSettingsDigit('8')" class="numpad-dark-btn !py-6 !text-4xl">8</button>
                    <button onclick="addSettingsDigit('9')" class="numpad-dark-btn !py-6 !text-4xl">9</button>
                    <button onclick="addSettingsDigit('4')" class="numpad-dark-btn !py-6 !text-4xl">4</button>
                    <button onclick="addSettingsDigit('5')" class="numpad-dark-btn !py-6 !text-4xl">5</button>
                    <button onclick="addSettingsDigit('6')" class="numpad-dark-btn !py-6 !text-4xl">6</button>
                    <button onclick="addSettingsDigit('1')" class="numpad-dark-btn !py-6 !text-4xl">1</button>
                    <button onclick="addSettingsDigit('2')" class="numpad-dark-btn !py-6 !text-4xl">2</button>
                    <button onclick="addSettingsDigit('3')" class="numpad-dark-btn !py-6 !text-4xl">3</button>
                    <button onclick="clearSettings()" class="numpad-dark-btn !py-6 !text-3xl text-red-400">C</button>
                    <button onclick="addSettingsDigit('0')" class="numpad-dark-btn col-span-2 !py-6 !text-4xl">0</button>
                </div>
                
                <button onclick="saveMarkenWert()" class="w-full py-6 bg-blue-600 text-white rounded-[2rem] font-black uppercase tracking-widest active:bg-blue-700 transition-colors">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-white text-slate-900 px-12 py-6 rounded-full shadow-2xl transition-all opacity-0 pointer-events-none z-[200] font-black uppercase text-center border border-slate-200"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // BroadcastChannel f√ºr Kundenansicht-Sync
        const bc = new BroadcastChannel('pos-sync');

        // Check if this is the Customer View
        const urlParams = new URLSearchParams(window.location.search);
        const isCustomerView = urlParams.get('mode') === 'customer';

        if (isCustomerView) {
            // RENDER KUNDENANSICHT
            document.title = "Kundenansicht - Sommerfest";
            document.body.innerHTML = `
                <div class="h-screen bg-slate-900 text-white flex flex-col justify-center items-center p-10 font-black relative overflow-hidden">
                    <h1 class="text-4xl md:text-6xl text-slate-500 mb-12 uppercase tracking-widest opacity-50">Ihre Bestellung</h1>
                    
                    <div class="bg-slate-800 p-12 md:p-20 rounded-[4rem] w-full max-w-5xl shadow-2xl flex flex-col gap-12 border border-slate-700 relative z-10">
                        <div class="flex justify-between items-center text-4xl md:text-6xl">
                            <span class="text-slate-400">Marken</span>
                            <span id="c-quantity">0x</span>
                        </div>
                        <hr class="border-slate-700">
                        <div class="flex justify-between items-center text-6xl md:text-8xl text-blue-400">
                            <span>Summe</span>
                            <span id="c-total">0,00 ‚Ç¨</span>
                        </div>
                        
                        <div class="flex justify-between items-center text-4xl md:text-5xl mt-12">
                            <span class="text-slate-400">Gegeben</span>
                            <span id="c-given">0,00 ‚Ç¨</span>
                        </div>
                        <div id="c-change-box" class="flex justify-between items-center text-5xl md:text-7xl text-green-400 mt-6 opacity-0 transition-opacity duration-300">
                            <span>Zur√ºck</span>
                            <span id="c-change">0,00 ‚Ç¨</span>
                        </div>
                    </div>

                    <div id="c-success" class="absolute inset-0 bg-green-500 z-50 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-500">
                        <span class="text-8xl md:text-[10rem] text-white drop-shadow-lg mb-8">üéâ</span>
                        <span class="text-5xl md:text-7xl text-white font-black drop-shadow-md">VIELEN DANK!</span>
                    </div>
                </div>
            `;

            bc.onmessage = (e) => {
                if (e.data.type === 'STATE') {
                    const p = e.data.payload;
                    document.getElementById('c-quantity').innerText = p.quantity + 'x';
                    document.getElementById('c-total').innerText = p.total.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
                    document.getElementById('c-given').innerText = (parseFloat(p.cashTyped)/100).toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
                    
                    const changeBox = document.getElementById('c-change-box');
                    if (p.change >= 0 && parseFloat(p.cashTyped) > 0 && p.quantity > 0) {
                        changeBox.classList.remove('opacity-0');
                        document.getElementById('c-change').innerText = p.change.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
                    } else {
                        changeBox.classList.add('opacity-0');
                    }
                } else if (e.data.type === 'SUCCESS') {
                    const s = document.getElementById('c-success');
                    s.classList.replace('opacity-0', 'opacity-100');
                    setTimeout(() => {
                        s.classList.replace('opacity-100', 'opacity-0');
                        document.getElementById('c-quantity').innerText = '0x';
                        document.getElementById('c-total').innerText = '0,00 ‚Ç¨';
                        document.getElementById('c-given').innerText = '0,00 ‚Ç¨';
                        document.getElementById('c-change-box').classList.add('opacity-0');
                    }, 4000);
                }
            };
            
            // Beende Ausf√ºhrung des restlichen Codes f√ºr die Kundenansicht
            throw new Error("Customer View initialized."); 
        }

        // --- HIER STARTET DIE NORMALE KASSEN-LOGIK ---

       const firebaseConfig = {
  apiKey: "AIzaSyCTMGml_KKj1wjmtzTJNubWyMvSaPU3cB8",
  authDomain: "sommerfest-kasse.firebaseapp.com",
  projectId: "sommerfest-kasse",
  storageBucket: "sommerfest-kasse.firebasestorage.app",
  messagingSenderId: "899854905140",
  appId: "1:899854905140:web:94be886a048356c7fb3f61"
};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'kasse-summer-24';

        // State
        let user = null;
        let MARKEN_WERT = 0.50;
        let currentQuantity = 0;
        let cashTyped = "0";
        let stats = { sold: 0, returned: 0, cash: 0, markenWert: 0.50, history: [] };
        
        // Modal States
        let pinTyped = "";
        let settingsTyped = "0";

        // Sync Helper for Customer Display
        const syncCustomerScreen = () => {
            const total = currentQuantity * MARKEN_WERT;
            const given = parseFloat(cashTyped) / 100;
            bc.postMessage({
                type: 'STATE',
                payload: {
                    quantity: currentQuantity,
                    markenWert: MARKEN_WERT,
                    cashTyped: cashTyped,
                    total: total,
                    change: given - total
                }
            });
        };

        window.openCustomerView = () => {
            window.open(window.location.href.split('?')[0] + '?mode=customer', '_blank');
        };

        const updatePrice = () => {
            document.getElementById('quantity').innerText = currentQuantity;
            const total = currentQuantity * MARKEN_WERT;
            document.getElementById('totalPrice').innerText = total.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
            document.getElementById('buyBtn').disabled = currentQuantity <= 0;
            document.getElementById('returnBtn').disabled = currentQuantity <= 0;
            calculateChange();
            syncCustomerScreen();
        };

        const calculateChange = () => {
            const given = parseFloat(cashTyped) / 100;
            const price = currentQuantity * MARKEN_WERT;
            const change = given - price;
            const box = document.getElementById('changeBox');
            if (given > 0 && change >= 0 && currentQuantity > 0) {
                box.classList.remove('hidden');
                document.getElementById('changeAmount').innerText = change.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
            } else {
                box.classList.add('hidden');
            }
        };

        window.switchTab = (tab) => {
            document.getElementById('tab-sell').classList.toggle('hidden', tab !== 'sell');
            document.getElementById('tab-stats').classList.toggle('hidden', tab !== 'stats');
            const btns = { 'sell': document.getElementById('nav-sell'), 'stats': document.getElementById('nav-stats') };
            Object.keys(btns).forEach(k => {
                btns[k].className = `px-8 py-3 rounded-[1.5rem] font-black transition-all ${k === tab ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400'}`;
            });
        };

        window.changeQuantity = (val) => { currentQuantity = Math.max(0, currentQuantity + val); updatePrice(); };
        window.setQuantity = (val) => { currentQuantity += val; updatePrice(); };

        window.addDigit = (digit) => {
            if (cashTyped === "0" && digit !== '00') cashTyped = digit;
            else if (cashTyped !== "0" && cashTyped.length < 9) cashTyped += digit;
            const val = parseFloat(cashTyped) / 100;
            document.getElementById('cashInput').innerText = val.toLocaleString('de-DE', { minimumFractionDigits: 2 });
            calculateChange();
            syncCustomerScreen();
        };

        window.clearCash = () => { 
            cashTyped = "0"; 
            document.getElementById('cashInput').innerText = "0,00"; 
            calculateChange(); 
            syncCustomerScreen();
        };

        window.processTransaction = async (type) => {
            if (!user) { showToast("Warte auf Cloud..."); return; }
            const total = currentQuantity * MARKEN_WERT;
            const item = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('de-DE'),
                type: type === 'buy' ? 'VERKAUF' : 'RETOURE',
                amount: currentQuantity,
                money: type === 'buy' ? total : -total
            };

            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'kassenbestand');
            try {
                await updateDoc(ref, {
                    sold: type === 'buy' ? (stats.sold || 0) + currentQuantity : (stats.sold || 0),
                    returned: type === 'return' ? (stats.returned || 0) + currentQuantity : (stats.returned || 0),
                    cash: type === 'buy' ? (stats.cash || 0) + total : (stats.cash || 0) - total,
                    history: arrayUnion(item)
                });
                
                // Erfolgsmeldung an Kundenansicht senden
                bc.postMessage({ type: 'SUCCESS' });
                showToast("ERFOLGREICH ‚úÖ");
                
                currentQuantity = 0; 
                window.clearCash(); 
                updatePrice();
            } catch(e) { showToast("Cloud-Fehler!"); }
        };

        // --- PIN LOGIC ---
        window.requestSettingsAccess = () => { 
            pinTyped = "";
            updatePinUI();
            document.getElementById('auth-modal').classList.remove('hidden'); 
        };
        
        window.closeAuth = () => {
            document.getElementById('auth-modal').classList.add('hidden');
        };

        window.addPinDigit = (d) => {
            if (pinTyped.length < 4) pinTyped += d;
            updatePinUI();
            if (pinTyped.length === 4) {
                setTimeout(window.checkPin, 100);
            }
        };

        window.clearPin = () => {
            pinTyped = "";
            updatePinUI();
        };

        window.updatePinUI = () => {
            for(let i=1; i<=4; i++) {
                const dot = document.getElementById(`pin-dot-${i}`);
                if(i <= pinTyped.length) dot.classList.replace('bg-slate-600', 'bg-blue-400');
                else dot.classList.replace('bg-blue-400', 'bg-slate-600');
            }
        };

        window.checkPin = () => {
            if (pinTyped === "5657") { // Standard PIN
                closeAuth();
                openSettings();
            } else { 
                showToast("PIN FALSCH"); 
                clearPin();
            }
        };

        // --- SETTINGS LOGIC ---
        window.openSettings = () => {
            settingsTyped = Math.round(MARKEN_WERT * 100).toString();
            updateSettingsUI();
            document.getElementById('settings-modal').classList.remove('hidden');
        };

        window.closeSettings = () => {
            document.getElementById('settings-modal').classList.add('hidden');
        };

        window.addSettingsDigit = (d) => {
            if (settingsTyped === "0") settingsTyped = d;
            else if (settingsTyped.length < 6) settingsTyped += d;
            updateSettingsUI();
        };

        window.clearSettings = () => {
            settingsTyped = "0";
            updateSettingsUI();
        };

        window.updateSettingsUI = () => {
            const val = parseFloat(settingsTyped) / 100;
            document.getElementById('settingsPriceDisplay').innerText = val.toLocaleString('de-DE', { minimumFractionDigits: 2 });
        };

        window.saveMarkenWert = async () => {
            const val = parseFloat(settingsTyped) / 100;
            if (isNaN(val) || val <= 0) {
                showToast("Ung√ºltiger Preis");
                return;
            }
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'kassenbestand');
            await updateDoc(ref, { markenWert: val });
            closeSettings();
            showToast("GESPEICHERT");
        };

        // --- GENERAL LOGIC ---
        window.resetStats = async () => {
            if (!confirm('ALLES L√ñSCHEN?')) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'kassenbestand');
            await setDoc(ref, { sold: 0, returned: 0, cash: 0, markenWert: MARKEN_WERT, history: [] });
        };

        window.deleteTransaction = async (item) => {
            if (!confirm('L√∂schen?')) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'kassenbestand');
            await updateDoc(ref, {
                sold: item.type === 'VERKAUF' ? stats.sold - item.amount : stats.sold,
                returned: item.type === 'RETOURE' ? stats.returned - item.amount : stats.returned,
                cash: stats.cash - item.money,
                history: arrayRemove(item)
            });
        };

        function updateUI() {
            document.getElementById('statMarken').innerText = stats.sold || 0;
            document.getElementById('statReturns').innerText = stats.returned || 0;
            document.getElementById('statTotal').innerText = (stats.cash || 0).toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
            const hist = document.getElementById('history');
            const data = [...(stats.history || [])].reverse();
            hist.innerHTML = data.length ? data.map(i => `
                <div class="flex justify-between items-center p-6 bg-white">
                    <div>
                        <p class="font-black text-slate-800">${i.amount}x ${i.type}</p>
                        <p class="text-[10px] text-slate-400 font-bold">${i.time}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="font-black text-slate-800 tabular-nums">${i.money.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</p>
                        <button onclick='deleteTransaction(${JSON.stringify(i)})' class="text-slate-300 hover:text-red-500">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('') : '<div class="p-20 text-center text-slate-300 font-bold">Keine Daten</div>';
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2500);
        }

        // 3. Auth & Sync mit Exponential Backoff
        const initSession = async (retries = 5, delay = 1000) => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                if (retries > 0) {
                    setTimeout(() => initSession(retries - 1, delay * 2), delay);
                } else {
                    document.getElementById('statusText').innerText = "LOGIN FEHLER";
                    showToast("Fehler: Anonymous Login in Firebase aktivieren!");
                }
            }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('syncStatus').classList.replace('bg-yellow-500', 'bg-green-500');
                document.getElementById('statusText').innerText = "VERBUNDEN";
                
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'kassenbestand');
                onSnapshot(ref, (s) => {
                    if (s.exists()) {
                        stats = s.data();
                        MARKEN_WERT = stats.markenWert || 0.50;
                        document.getElementById('valLabel').innerText = MARKEN_WERT.toFixed(2).replace('.', ',');
                        updateUI();
                        updatePrice();
                    } else {
                        setDoc(ref, stats);
                    }
                }, (e) => showToast("Sync Fehler"));
            }
        });

        // Starte alles
        updatePrice();
        initSession();
    </script>
</body>
</html>
