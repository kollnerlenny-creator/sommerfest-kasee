<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kasse Sommerfest - Modern UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700;900&display=swap');
        
        :root {
            --apple-bg: #f5f5f7;
            --apple-card: #ffffff;
            --apple-blue: #007aff;
            --apple-green: #34c759;
            --apple-orange: #ff9500;
        }

        body { 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: var(--apple-bg);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
            color: #1d1d1f;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Ultra-runde Buttons */
        .btn-round {
            @apply rounded-full transition-all active:scale-95 flex items-center justify-center select-none font-semibold;
        }

        .numpad-btn {
            @apply bg-white hover:bg-slate-50 active:bg-slate-200 text-slate-800 text-3xl font-bold py-6 shadow-sm border border-slate-100;
        }
        
        .action-btn {
            @apply py-6 text-white text-lg font-bold shadow-lg uppercase tracking-wider;
        }

        .quantity-display {
            font-size: 8rem;
            line-height: 1;
            font-weight: 900;
            background: linear-gradient(180deg, #1d1d1f 0%, #434345 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes sun-glow {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        .animate-sun {
            animation: sun-glow 4s ease-in-out infinite;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d1d6; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-8">
        <!-- Modern Header -->
        <header class="flex justify-between items-center mb-8 px-2">
            <div>
                <h1 class="text-3xl font-black tracking-tight text-slate-900">Sommerkasse</h1>
                <div class="flex items-center gap-2 mt-1">
                    <div id="syncStatus" class="w-2 h-2 rounded-full bg-yellow-400"></div>
                    <span id="statusText" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Wird geladen...</span>
                </div>
            </div>
            <div class="flex items-center gap-3 bg-white/50 p-2 rounded-full border border-white/20 shadow-sm">
                <button onclick="switchTab('sell')" id="nav-sell" class="px-6 py-2 btn-round bg-white text-slate-900 shadow-sm">Verkauf</button>
                <button onclick="switchTab('stats')" id="nav-stats" class="px-6 py-2 btn-round text-slate-400">Bilanz</button>
                <div class="w-px h-6 bg-slate-200 mx-1"></div>
                <button onclick="openCustomerView()" class="p-2 text-slate-400 hover:text-blue-500 transition-colors">üñ•Ô∏è</button>
                <button onclick="requestSettingsAccess()" class="p-2 text-slate-400 hover:text-slate-800 transition-colors">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- Verkauf Ansicht -->
        <div id="tab-sell" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Linke Spalte: Mengensteuerung -->
            <div class="space-y-6">
                <div class="bg-white rounded-[3rem] p-8 shadow-xl shadow-slate-200/50 border border-slate-50 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-8 opacity-5 pointer-events-none">
                        <span class="text-9xl">‚òÄÔ∏è</span>
                    </div>
                    
                    <h2 class="text-center text-xs font-black text-slate-300 uppercase tracking-[0.3em] mb-4">Anzahl Marken</h2>
                    
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="changeQuantity(-1)" class="w-20 h-20 btn-round bg-slate-100 text-slate-800 text-3xl">Ôºç</button>
                        <div class="text-center">
                            <span id="quantity" class="quantity-display tabular-nums">0</span>
                        </div>
                        <button onclick="changeQuantity(1)" class="w-20 h-20 btn-round bg-blue-50 text-blue-600 text-3xl">Ôºã</button>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setQuantity(5)" class="py-4 btn-round bg-slate-50 text-slate-600 border border-slate-100 font-bold">+5</button>
                        <button onclick="setQuantity(10)" class="py-4 btn-round bg-slate-50 text-slate-600 border border-slate-100 font-bold">+10</button>
                        <button onclick="setQuantity(20)" class="py-4 btn-round bg-slate-50 text-slate-600 border border-slate-100 font-bold">+20</button>
                    </div>
                </div>

                <div class="bg-blue-600 rounded-[3rem] p-10 shadow-2xl shadow-blue-200 text-center text-white">
                    <p class="text-blue-200 font-bold uppercase text-[11px] tracking-widest mb-1">Zu zahlen (√° <span id="valLabel">0,50</span>‚Ç¨)</p>
                    <h2 id="totalPrice" class="text-6xl font-black tabular-nums">0,00 ‚Ç¨</h2>
                </div>
            </div>

            <!-- Rechte Spalte: Numpad & Bezahlung -->
            <div class="bg-white rounded-[3rem] p-8 shadow-xl shadow-slate-200/50 border border-slate-50 flex flex-col">
                <div class="mb-6 bg-slate-50 rounded-[2.5rem] p-6 border border-slate-100">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Gegeben</span>
                        <div class="flex items-baseline gap-1">
                            <span id="cashInput" class="text-5xl font-black text-slate-800 tabular-nums">0,00</span>
                            <span class="text-xl font-bold text-slate-400">‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <!-- Helles Numpad -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button onclick="addDigit('7')" class="btn-round numpad-btn">7</button>
                    <button onclick="addDigit('8')" class="btn-round numpad-btn">8</button>
                    <button onclick="addDigit('9')" class="btn-round numpad-btn">9</button>
                    <button onclick="addDigit('4')" class="btn-round numpad-btn">4</button>
                    <button onclick="addDigit('5')" class="btn-round numpad-btn">5</button>
                    <button onclick="addDigit('6')" class="btn-round numpad-btn">6</button>
                    <button onclick="addDigit('1')" class="btn-round numpad-btn">1</button>
                    <button onclick="addDigit('2')" class="btn-round numpad-btn">2</button>
                    <button onclick="addDigit('3')" class="btn-round numpad-btn">3</button>
                    <button onclick="clearCash()" class="btn-round numpad-btn text-red-500">C</button>
                    <button onclick="addDigit('0')" class="btn-round numpad-btn col-span-2">0</button>
                </div>

                <div id="changeBox" class="bg-green-50 rounded-[2rem] p-5 mb-6 hidden border border-green-100">
                    <div class="flex justify-between items-center text-green-700">
                        <span class="font-bold uppercase text-[10px] tracking-widest">Wechselgeld</span>
                        <span id="changeAmount" class="text-3xl font-black tabular-nums">0,00 ‚Ç¨</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-auto">
                    <button onclick="processTransaction('buy')" id="buyBtn" class="btn-round action-btn bg-green-500 active:bg-green-600 disabled:bg-slate-100 disabled:text-slate-300 disabled:shadow-none" disabled>KASSIEREN</button>
                    <button onclick="processTransaction('return')" id="returnBtn" class="btn-round action-btn bg-orange-500 active:bg-orange-600 disabled:bg-slate-100 disabled:text-slate-300 disabled:shadow-none" disabled>RETOURE</button>
                </div>
            </div>
        </div>

        <!-- Bilanz Ansicht -->
        <div id="tab-stats" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2">Gesamt Verkauft</p>
                    <h3 id="statMarken" class="text-5xl font-black text-slate-800">0</h3>
                </div>
                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <p class="text-[10px] text-orange-400 font-black uppercase tracking-widest mb-2">Retouren</p>
                    <h3 id="statReturns" class="text-5xl font-black text-orange-500">0</h3>
                </div>
                <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 bg-blue-50/20">
                    <p class="text-[10px] text-blue-500 font-black uppercase tracking-widest mb-2">Kassenstand</p>
                    <h3 id="statTotal" class="text-5xl font-black text-blue-600">0,00 ‚Ç¨</h3>
                </div>
            </div>
            
            <div class="bg-white rounded-[3rem] shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                <div class="p-8 border-b flex justify-between items-center">
                    <h2 class="font-black text-slate-800 text-xl tracking-tight">Journal</h2>
                    <button onclick="resetStats()" class="text-[10px] font-black text-red-400 uppercase tracking-widest bg-red-50 px-4 py-2 btn-round">Reset</button>
                </div>
                <div id="history" class="max-h-[50vh] overflow-y-auto divide-y divide-slate-50"></div>
            </div>
        </div>
    </div>

    <!-- Modals (PIN & Settings) -->
    <div id="auth-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-xl z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-[3rem] p-8 max-w-sm w-full shadow-2xl animate-in zoom-in-95 duration-200">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-slate-800">Sicherheit</h2>
                <button onclick="closeAuth()" class="text-slate-400 font-bold text-sm">X</button>
            </div>
            <div class="flex justify-center gap-4 mb-8">
                <div id="pin-dot-1" class="w-4 h-4 rounded-full bg-slate-100 transition-colors"></div>
                <div id="pin-dot-2" class="w-4 h-4 rounded-full bg-slate-100 transition-colors"></div>
                <div id="pin-dot-3" class="w-4 h-4 rounded-full bg-slate-100 transition-colors"></div>
                <div id="pin-dot-4" class="w-4 h-4 rounded-full bg-slate-100 transition-colors"></div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="addPinDigit('7')" class="btn-round numpad-btn !text-2xl !py-4">7</button>
                <button onclick="addPinDigit('8')" class="btn-round numpad-btn !text-2xl !py-4">8</button>
                <button onclick="addPinDigit('9')" class="btn-round numpad-btn !text-2xl !py-4">9</button>
                <button onclick="addPinDigit('4')" class="btn-round numpad-btn !text-2xl !py-4">4</button>
                <button onclick="addPinDigit('5')" class="btn-round numpad-btn !text-2xl !py-4">5</button>
                <button onclick="addPinDigit('6')" class="btn-round numpad-btn !text-2xl !py-4">6</button>
                <button onclick="addPinDigit('1')" class="btn-round numpad-btn !text-2xl !py-4">1</button>
                <button onclick="addPinDigit('2')" class="btn-round numpad-btn !text-2xl !py-4">2</button>
                <button onclick="addPinDigit('3')" class="btn-round numpad-btn !text-2xl !py-4">3</button>
                <button onclick="clearPin()" class="btn-round numpad-btn !text-xl !py-4 text-red-500">C</button>
                <button onclick="addPinDigit('0')" class="btn-round numpad-btn col-span-2 !text-2xl !py-4">0</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-xl z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-[3rem] p-8 max-w-sm w-full shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-slate-800">Preis/Marke</h2>
                <button onclick="closeSettings()" class="text-slate-400 font-bold text-sm">X</button>
            </div>
            <div class="text-center mb-8 bg-slate-50 p-6 rounded-[2rem] border border-slate-100">
                <span id="settingsPriceDisplay" class="text-6xl font-black text-slate-800 tabular-nums">0,00</span>
                <span class="text-2xl text-slate-400 font-bold">‚Ç¨</span>
            </div>
            <div class="grid grid-cols-3 gap-3 mb-6">
                <button onclick="addSettingsDigit('7')" class="btn-round numpad-btn !text-2xl !py-4">7</button>
                <button onclick="addSettingsDigit('8')" class="btn-round numpad-btn !text-2xl !py-4">8</button>
                <button onclick="addSettingsDigit('9')" class="btn-round numpad-btn !text-2xl !py-4">9</button>
                <button onclick="addSettingsDigit('4')" class="btn-round numpad-btn !text-2xl !py-4">4</button>
                <button onclick="addSettingsDigit('5')" class="btn-round numpad-btn !text-2xl !py-4">5</button>
                <button onclick="addSettingsDigit('6')" class="btn-round numpad-btn !text-2xl !py-4">6</button>
                <button onclick="addSettingsDigit('1')" class="btn-round numpad-btn !text-2xl !py-4">1</button>
                <button onclick="addSettingsDigit('2')" class="btn-round numpad-btn !text-2xl !py-4">2</button>
                <button onclick="addSettingsDigit('3')" class="btn-round numpad-btn !text-2xl !py-4">3</button>
                <button onclick="clearSettings()" class="btn-round numpad-btn !text-xl !py-4 text-red-500">C</button>
                <button onclick="addSettingsDigit('0')" class="btn-round numpad-btn col-span-2 !text-2xl !py-4">0</button>
            </div>
            <button onclick="saveMarkenWert()" class="w-full py-5 bg-blue-600 text-white btn-round text-lg font-bold">Speichern</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-full shadow-2xl transition-all opacity-0 pointer-events-none z-[200] font-bold text-center"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const bc = new BroadcastChannel('pos-sync');
        const urlParams = new URLSearchParams(window.location.search);
        const isCustomerView = urlParams.get('mode') === 'customer';

        if (isCustomerView) {
            document.title = "Kundenansicht";
            document.body.innerHTML = `
                <div class="h-screen flex flex-col items-center justify-center p-6 font-semibold overflow-hidden transition-colors duration-1000" id="c-bg" style="background-color: #f5f5f7;">
                    
                    <!-- Bildschirmschoner -->
                    <div id="c-screensaver" class="absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-orange-400 to-yellow-300 z-0">
                        <div class="text-[12rem] animate-sun drop-shadow-2xl">‚òÄÔ∏è</div>
                        <h1 class="text-white text-6xl font-black mt-8 tracking-tighter text-center">Sommerfest<br><span class="opacity-80">Marken-Kasse</span></h1>
                    </div>

                    <!-- Aktive Bestellung -->
                    <div id="c-order-ui" class="relative z-10 w-full max-w-4xl bg-white rounded-[4rem] p-12 shadow-2xl border border-white opacity-0 scale-95 transition-all duration-500">
                        <div class="flex justify-between items-center mb-10">
                            <span class="text-4xl text-slate-300 font-black uppercase tracking-widest">Marken</span>
                            <span id="c-quantity" class="text-8xl font-black text-slate-800">0</span>
                        </div>
                        <div class="h-px bg-slate-100 mb-10"></div>
                        <div class="flex justify-between items-center mb-12">
                            <span class="text-4xl text-slate-300 font-black uppercase tracking-widest">Summe</span>
                            <span id="c-total" class="text-9xl font-black text-blue-600">0,00 ‚Ç¨</span>
                        </div>
                        <div id="c-given-row" class="flex justify-between items-center mb-6 opacity-0 transition-all">
                            <span class="text-2xl text-slate-300 font-bold uppercase">Gegeben</span>
                            <span id="c-given" class="text-4xl font-bold text-slate-400">0,00 ‚Ç¨</span>
                        </div>
                        <div id="c-change-box" class="bg-green-500 rounded-[2.5rem] p-8 text-white flex justify-between items-center opacity-0 translate-y-4 transition-all">
                            <span class="text-3xl font-bold">R√ºckgeld</span>
                            <span id="c-change" class="text-6xl font-black">0,00 ‚Ç¨</span>
                        </div>
                    </div>

                    <div id="c-success" class="absolute inset-0 bg-green-500 z-50 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-500">
                        <span class="text-[15rem] drop-shadow-2xl mb-4">‚òÄÔ∏è</span>
                        <span class="text-6xl text-white font-black text-center">VIELEN DANK!<br><span class="text-2xl opacity-80">Genie√üen Sie das Fest!</span></span>
                    </div>
                </div>
            `;

            bc.onmessage = (e) => {
                const saver = document.getElementById('c-screensaver');
                const orderUI = document.getElementById('c-order-ui');
                
                if (e.data.type === 'STATE') {
                    const p = e.data.payload;
                    if (p.quantity > 0) {
                        saver.classList.add('opacity-0', 'pointer-events-none');
                        orderUI.classList.remove('opacity-0', 'scale-95');
                        document.getElementById('c-quantity').innerText = p.quantity;
                        document.getElementById('c-total').innerText = p.total.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
                        
                        const given = parseFloat(p.cashTyped) / 100;
                        if (given > 0) {
                            document.getElementById('c-given-row').classList.remove('opacity-0');
                            document.getElementById('c-given').innerText = given.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
                            
                            if (p.change >= 0) {
                                document.getElementById('c-change-box').classList.remove('opacity-0', 'translate-y-4');
                                document.getElementById('c-change').innerText = p.change.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
                            }
                        } else {
                            document.getElementById('c-given-row').classList.add('opacity-0');
                            document.getElementById('c-change-box').classList.add('opacity-0', 'translate-y-4');
                        }
                    } else {
                        saver.classList.remove('opacity-0', 'pointer-events-none');
                        orderUI.classList.add('opacity-0', 'scale-95');
                    }
                } else if (e.data.type === 'SUCCESS') {
                    const s = document.getElementById('c-success');
                    s.classList.replace('opacity-0', 'opacity-100');
                    setTimeout(() => {
                        s.classList.replace('opacity-100', 'opacity-0');
                    }, 3500);
                }
            };
            throw new Error("Customer View initialized."); 
        }

        // --- KASSEN LOGIK ---
      const firebaseConfig = {
  apiKey: "AIzaSyCTMGml_KKj1wjmtzTJNubWyMvSaPU3cB8",
  authDomain: "sommerfest-kasse.firebaseapp.com",
  projectId: "sommerfest-kasse",
  storageBucket: "sommerfest-kasse.firebasestorage.app",
  messagingSenderId: "899854905140",
  appId: "1:899854905140:web:94be886a048356c7fb3f61"
};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'kasse-summer-modern';

        let user = null;
        let MARKEN_WERT = 0.50;
        let currentQuantity = 0;
        let cashTyped = "0";
        let stats = { sold: 0, returned: 0, cash: 0, markenWert: 0.50, history: [] };
        let pinTyped = "";
        let settingsTyped = "0";

        const syncCustomerScreen = () => {
            const total = currentQuantity * MARKEN_WERT;
            const given = parseFloat(cashTyped) / 100;
            bc.postMessage({
                type: 'STATE',
                payload: {
                    quantity: currentQuantity,
                    cashTyped: cashTyped,
                    total: total,
                    change: given - total
                }
            });
        };

        window.openCustomerView = () => window.open(window.location.href.split('?')[0] + '?mode=customer', '_blank');

        const updatePrice = () => {
            document.getElementById('quantity').innerText = currentQuantity;
            const total = currentQuantity * MARKEN_WERT;
            document.getElementById('totalPrice').innerText = total.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
            document.getElementById('buyBtn').disabled = currentQuantity <= 0;
            document.getElementById('returnBtn').disabled = currentQuantity <= 0;
            
            const given = parseFloat(cashTyped) / 100;
            const change = given - total;
            const box = document.getElementById('changeBox');
            if (given > 0 && change >= 0 && currentQuantity > 0) {
                box.classList.remove('hidden');
                document.getElementById('changeAmount').innerText = change.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
            } else {
                box.classList.add('hidden');
            }
            syncCustomerScreen();
        };

        window.changeQuantity = (val) => { currentQuantity = Math.max(0, currentQuantity + val); updatePrice(); };
        window.setQuantity = (val) => { currentQuantity += val; updatePrice(); };

        window.addDigit = (digit) => {
            if (cashTyped === "0") cashTyped = digit;
            else if (cashTyped.length < 8) cashTyped += digit;
            document.getElementById('cashInput').innerText = (parseFloat(cashTyped)/100).toLocaleString('de-DE', { minimumFractionDigits: 2 });
            updatePrice();
        };

        window.clearCash = () => { cashTyped = "0"; document.getElementById('cashInput').innerText = "0,00"; updatePrice(); };

        window.processTransaction = async (type) => {
            if (!user) return showToast("Bitte warten...");
            const total = currentQuantity * MARKEN_WERT;
            const item = {
                id: Date.now(),
                time: new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'}),
                type: type === 'buy' ? 'VERKAUF' : 'RETOURE',
                amount: currentQuantity,
                money: type === 'buy' ? total : -total
            };

            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'kassenbestand');
            try {
                // Sicherstellen dass Document existiert
                const snap = await getDoc(ref);
                if (!snap.exists()) {
                    await setDoc(ref, stats);
                }

                await updateDoc(ref, {
                    sold: type === 'buy' ? (stats.sold || 0) + currentQuantity : (stats.sold || 0),
                    returned: type === 'return' ? (stats.returned || 0) + currentQuantity : (stats.returned || 0),
                    cash: type === 'buy' ? (stats.cash || 0) + total : (stats.cash || 0) - total,
                    history: arrayUnion(item)
                });
                
                bc.postMessage({ type: 'SUCCESS' });
                showToast("ERLEDIGT ‚úÖ");
                currentQuantity = 0; clearCash();
            } catch(e) { 
                console.error(e);
                showToast("Fehler beim Speichern"); 
            }
        };

        // UI Tabs
        window.switchTab = (tab) => {
            document.getElementById('tab-sell').classList.toggle('hidden', tab !== 'sell');
            document.getElementById('tab-stats').classList.toggle('hidden', tab !== 'stats');
            const btns = { 'sell': document.getElementById('nav-sell'), 'stats': document.getElementById('nav-stats') };
            Object.keys(btns).forEach(k => {
                btns[k].className = `px-6 py-2 btn-round transition-all ${k === tab ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400'}`;
            });
        };

        // PIN & Settings
        window.requestSettingsAccess = () => { pinTyped = ""; updatePinUI(); document.getElementById('auth-modal').classList.remove('hidden'); };
        window.closeAuth = () => document.getElementById('auth-modal').classList.add('hidden');
        window.addPinDigit = (d) => {
            if (pinTyped.length < 4) pinTyped += d;
            updatePinUI();
            if (pinTyped.length === 4) {
                if (pinTyped === "5657") { closeAuth(); openSettings(); }
                else { showToast("PIN FALSCH"); pinTyped = ""; updatePinUI(); }
            }
        };
        window.updatePinUI = () => {
            for(let i=1; i<=4; i++) {
                const dot = document.getElementById(`pin-dot-${i}`);
                dot.className = `w-4 h-4 rounded-full transition-all ${i <= pinTyped.length ? 'bg-blue-500 scale-125' : 'bg-slate-100'}`;
            }
        };
        window.clearPin = () => { pinTyped = ""; updatePinUI(); };

        window.openSettings = () => {
            settingsTyped = Math.round(MARKEN_WERT * 100).toString();
            updateSettingsUI();
            document.getElementById('settings-modal').classList.remove('hidden');
        };
        window.closeSettings = () => document.getElementById('settings-modal').classList.add('hidden');
        window.addSettingsDigit = (d) => {
            if (settingsTyped === "0") settingsTyped = d;
            else if (settingsTyped.length < 5) settingsTyped += d;
            updateSettingsUI();
        };
        window.clearSettings = () => { settingsTyped = "0"; updateSettingsUI(); };
        window.updateSettingsUI = () => {
            document.getElementById('settingsPriceDisplay').innerText = (parseFloat(settingsTyped)/100).toLocaleString('de-DE', { minimumFractionDigits: 2 });
        };
        window.saveMarkenWert = async () => {
            const val = parseFloat(settingsTyped) / 100;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'kassenbestand');
            try {
                const snap = await getDoc(ref);
                if (!snap.exists()) {
                    await setDoc(ref, {...stats, markenWert: val});
                } else {
                    await updateDoc(ref, { markenWert: val });
                }
                closeSettings();
                showToast("Preis aktualisiert");
            } catch(e) { showToast("Fehler!"); }
        };

        window.resetStats = async () => {
            if (!confirm('Wirklich alles auf Null setzen?')) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'kassenbestand');
            await setDoc(ref, { sold: 0, returned: 0, cash: 0, markenWert: MARKEN_WERT, history: [] });
            showToast("Journal geleert");
        };

        window.deleteTransaction = async (item) => {
            if (!confirm('Eintrag l√∂schen?')) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'kassenbestand');
            await updateDoc(ref, {
                sold: item.type === 'VERKAUF' ? stats.sold - item.amount : stats.sold,
                returned: item.type === 'RETOURE' ? stats.returned - item.amount : stats.returned,
                cash: stats.cash - item.money,
                history: arrayRemove(item)
            });
        };

        function updateUI() {
            document.getElementById('statMarken').innerText = stats.sold || 0;
            document.getElementById('statReturns').innerText = stats.returned || 0;
            document.getElementById('statTotal').innerText = (stats.cash || 0).toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
            const hist = document.getElementById('history');
            const data = [...(stats.history || [])].reverse();
            hist.innerHTML = data.length ? data.map(i => `
                <div class="flex justify-between items-center p-6 bg-white hover:bg-slate-50 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${i.type === 'VERKAUF' ? 'bg-green-50 text-green-600' : 'bg-orange-50 text-orange-600'}">
                            ${i.type === 'VERKAUF' ? '‚Üì' : '‚Üë'}
                        </div>
                        <div>
                            <p class="font-bold text-slate-800">${i.amount}x ${i.type}</p>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${i.time}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <p class="font-black text-slate-800 tabular-nums text-lg">${i.money.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</p>
                        <button onclick='deleteTransaction(${JSON.stringify(i)})' class="text-slate-200 hover:text-red-400 transition-colors">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('') : '<div class="p-20 text-center text-slate-300 font-bold">Noch keine Buchungen</div>';
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2500);
        }

        // Firebase Auth & Listener
        const start = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('syncStatus').classList.replace('bg-yellow-400', 'bg-green-500');
                document.getElementById('statusText').innerText = "Online";
                
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'kassenbestand');
                onSnapshot(ref, (s) => {
                    if (s.exists()) {
                        stats = s.data();
                        MARKEN_WERT = stats.markenWert || 0.50;
                        document.getElementById('valLabel').innerText = MARKEN_WERT.toFixed(2).replace('.', ',');
                        updateUI();
                        updatePrice();
                    } else {
                        setDoc(ref, stats);
                    }
                }, (e) => showToast("Sync Fehler"));
            }
        });

        start();
    </script>
</body>
</html>
